.base:
  image: dtzar/helm-kubectl:3.3.1
  tags:
    - docker
    - privileged
    - debug
  only:
    - merge_requests
    - master

.test-install:
  extends: .base
  before_script:
    # Install KinD
    - curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.8.1/kind-linux-amd64
    - chmod +x ./kind
    - mv ./kind /usr/bin/kind
    # Install Docker
    - apk add docker
    # Patch KinD config to listen on docker service's IP address
    - "sed -i 's/apiServerAddress: .*/apiServerAddress: '$(grep 'docker' /etc/hosts | awk '{print $1}')/ dev/ping_kind_config.yaml"
  services:
    - docker:18.09-dind

stages:
  - build helm
  - test

build helm package:
  stage: build helm
  extends: .base
  script:
    - helm package ./k8s -d k8s/release
    - sleep 3000
  artifacts:
    paths:
    - k8s/release/

test lint:
  stage: test
  extends: .base
  script:
    - helm lint ./k8s -f values.yaml

test install ping:
  stage: test
  extends: .test-install
  script:
    - kind create cluster --config dev/ping_kind_config.yaml --image kindest/node:v1.17.5
    - helm install ping k8s/release/dnation-ping-*.tgz


